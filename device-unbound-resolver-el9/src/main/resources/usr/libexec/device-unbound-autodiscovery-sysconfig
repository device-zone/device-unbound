#!/bin/sh
  
if test "$1" = "start"; then

  doipv4=yes
  doipv6=yes

  if test -f "/etc/device/system/dns/resolver/protocol.txt"; then
    protocol="$(head -n 1 /etc/device/system/dns/resolver/protocol.txt)"
    if test "${protocol}" == "all"; then
      doipv4=yes
      doipv6=yes
    elif test "${protocol}" == "ipv4-only"; then
      doipv4=yes
      doipv6=no
    elif test "${protocol}" == "ipv6-only"; then
      doipv4=no
      doipv6=yes
    fi
  fi

  cat > "${TMPDIR}/sysconfig.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

val-log-level: 2
ede: yes
do-ip4: ${doipv4}
do-ip6: ${doipv6}
EOF

  install -m 644 "${TMPDIR}/sysconfig.conf" "/etc/unbound/local.d/sysconfig.conf"
  rm -f "${TMPDIR}/sysconfig.conf"

fi

